<!-- Chatbot Stylesheet -->
<link rel="stylesheet" href="/layout/chatbot.css">

<!-- Chatbot Core Logic Module -->
<script src="/layout/chatbot-core.js"></script>
<!-- Chatbot Voice Assistant Module -->
<script src="/layout/chatbot-voice.js"></script>
<!-- Chatbot Zone Editor Module -->
<script src="/layout/chatbot-zone-editor.js"></script>
<!-- Chatbot Flow Diagram Renderer Module -->
<script src="/layout/chatbot-flow-diagram.js"></script>
<!-- Chatbot Markdown/Streaming Utilities Module -->
<script src="/layout/chatbot-markdown.js"></script>

<!-- Chatbot Offcanvas Panel - Right side panel that pushes main content -->
<div class="offcanvas offcanvas-end chatbot-panel border-0" id="chatbot-offcanvas" tabindex="-1"
  aria-labelledby="chatbot-offcanvas" data-bs-backdrop="false" data-bs-scroll="true">
  <!-- Resize Handle - Drag to resize chatbot width -->
  <div class="chatbot-resize-handle" id="chatbot-resize-handle" title="Drag to resize">
    <div class="resize-handle-line"></div>
  </div>
  <!-- Chatbot Header - Contains tabs and action buttons -->
  <div
    class="offcanvas-header border-bottom border-translucent px-3 py-2 d-flex align-items-center justify-content-between gap-2">
    <!-- Left: Chat tabs list (dynamically populated by JS) -->
    <ul class="nav nav-underline fs-9 flex-nowrap overflow-x-auto chatbot-tabs me-2" id="chatbot-tabs" role="tablist"
      aria-label="Chat tabs">
      <!-- Tabs injected by JS -->
    </ul>

    <!-- Right: Action buttons -->
    <div class="d-flex align-items-center gap-2 flex-shrink-0">
      <!-- New tab button -->
      <button class="btn btn-link p-0 d-flex align-items-center" type="button" id="chatbot-new-tab"
        aria-label="New chat tab" title="New chat">
        <span class="fas fa-plus text-body"></span>
      </button>

      <!-- Chat history dropdown (placeholder for future implementation) -->
      <div class="dropdown">
        <button class="btn btn-link p-0 dropdown-toggle dropdown-caret-none transition-none d-flex align-items-center"
          type="button" id="chatbot-history-dropdown" data-bs-toggle="dropdown" data-boundary="window"
          aria-haspopup="true" aria-expanded="false" aria-label="Chat history" title="Chat history">
          <span class="far fa-clock text-body"></span>
        </button>
        <div class="dropdown-menu dropdown-menu-end py-2" aria-labelledby="chatbot-history-dropdown">
          <h6 class="dropdown-header">Chat history (dummy)</h6>
          <a class="dropdown-item" href="#!">New chat 1 — Camera status</a>
          <a class="dropdown-item" href="#!">New chat 2 — Events today</a>
          <a class="dropdown-item" href="#!">New chat 3 — Agent settings</a>
          <div class="dropdown-divider"></div>
          <a class="dropdown-item text-body-tertiary" href="#!">Later we'll connect realtime history</a>
        </div>
      </div>

      <!-- More options dropdown -->
      <div class="btn-reveal-trigger">
        <button class="btn btn-link p-0 dropdown-toggle dropdown-caret-none transition-none d-flex align-items-center"
          type="button" id="chatbot-dropdown" data-bs-toggle="dropdown" data-boundary="window" aria-haspopup="true"
          aria-expanded="false" data-bs-reference="parent" aria-label="More options" title="More options">
          <span class="fas fa-ellipsis-h text-body"></span>
        </button>
        <div class="dropdown-menu dropdown-menu-end py-2" aria-labelledby="chatbot-dropdown">
          <a class="dropdown-item" href="#!" data-chatbot-action="clear">Clear chat</a>
          <a class="dropdown-item" href="#!">Search in chat</a>
          <a class="dropdown-item" href="#!">Show history</a>
          <a class="dropdown-item" href="#!">Settings</a>
        </div>
      </div>

      <!-- Close chatbot button -->
      <button class="btn p-1 fw-bolder" type="button" data-bs-dismiss="offcanvas" aria-label="Close">
        <span class="fas fa-times fs-8"></span>
      </button>
    </div>
  </div>
  <!-- Chatbot Body - Contains messages and input area -->
  <div class="offcanvas-body p-0 d-flex flex-column">
    <div class="card-body chat p-0 flex-1 d-flex flex-column">
      <!-- Messages container with scroll -->
      <div class="chat-messages-wrap h-100">
        <div class="chat-messages d-flex flex-column scrollbar h-100 p-3">
          <!-- Messages injected by JS -->
        </div>
        <!-- Voice UI Overlay - Shows animated orb during voice interaction (hidden by default) -->
        <div class="voice-ui-overlay d-none" id="voice-ui-overlay" aria-hidden="true">
          <div class="voice-ui-inner">
            <!-- Animated orb that reacts to audio input -->
            <div class="orb-container" id="voice-orb">
              <div class="orb-clip">
                <div class="orb">
                  <div class="orb-inner"></div>
                  <div class="orb-inner"></div>
                </div>
              </div>
            </div>
            <!-- Voice status label (Listening/Processing/Speaking) -->
            <div class="voice-status-label" id="voice-status-label"></div>
          </div>
        </div>
      </div>
    </div>
    <!-- Chatbot Footer - Input area and controls -->
    <div class="card-footer px-3 py-3" style="background: transparent;">
      <div class="chatbot-input-container">
        <!-- Text input area (autosizes via JS) -->
        <textarea class="form-control fs-9" placeholder="Message Agent..." id="chatbot-input" rows="1"></textarea>

        <!-- Controls area - Mode selector and action buttons -->
        <div class="chatbot-controls-area">
          <!-- Left: Mode selector and auto toggle -->
          <div class="chatbot-btn-group">
            <!-- Agent/General mode dropdown -->
            <div class="dropdown">
              <button class="btn chatbot-pill-btn dropdown-toggle dropdown-caret-none" type="button"
                id="chatbot-mode-dropdown" data-bs-toggle="dropdown" aria-expanded="false">
                <span class="fas fa-infinity fs-10"></span>
                <span id="chatbot-mode-label">Agent</span>
                <span class="fas fa-chevron-down fs-11 opacity-50"></span>
              </button>
              <ul class="dropdown-menu" aria-labelledby="chatbot-mode-dropdown">
                <li><a class="dropdown-item" href="#!" data-chatbot-mode="general">General</a></li>
                <li><a class="dropdown-item" href="#!" data-chatbot-mode="agent">Agent</a></li>
              </ul>
            </div>

            <!-- Auto toggle button (placeholder for future feature) -->
            <button class="btn chatbot-pill-btn" type="button">
              <span>Auto</span>
              <span class="fas fa-chevron-down fs-11 opacity-50"></span>
            </button>
          </div>

          <!-- Right: Action icons and send/voice button -->
          <div class="chatbot-btn-group ms-auto">
            <!-- Processing indicator (static placeholder) -->
            <button class="chatbot-action-icon" title="Processing">
              <span class="fas fa-circle-notch fa-spin fs-10 opacity-50"></span>
            </button>

            <!-- Mention button (placeholder) -->
            <button class="chatbot-action-icon" title="Mention (@)">
              <span class="fas fa-at fs-9"></span>
            </button>

            <!-- Web search button (placeholder) -->
            <button class="chatbot-action-icon" title="Search Web">
              <span class="fas fa-globe fs-9"></span>
            </button>

            <!-- Upload image button (placeholder) -->
            <button class="chatbot-action-icon" title="Upload Image">
              <span class="far fa-image fs-9"></span>
            </button>

            <!-- Send/Voice button - Dynamically switches between send, voice, and stop states -->
            <button class="chatbot-send-btn send-btn ms-2 voice-assistant-state" type="button"
              aria-label="Voice Assistant" title="Voice Assistant">
              <!-- Voice Assistant Icon (shown when textarea is empty) -->
              <span class="voice-icon">
                <span class="voice-icon-bar"></span>
                <span class="voice-icon-bar"></span>
                <span class="voice-icon-bar"></span>
              </span>
              <!-- Send Icon (shown when textarea has text) -->
              <span class="send-icon" style="display: none;">
                <span class="fas fa-arrow-up fs-9"></span>
              </span>
              <!-- Stop Icon (shown when streaming text response) -->
              <span class="stop-icon" style="display: none;">
                <span class="fas fa-square fs-10"></span>
              </span>
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Toggle Button - Floating button to open chatbot panel -->
<a class="card setting-toggle" href="#chatbot-offcanvas" data-bs-toggle="offcanvas" aria-controls="chatbot-offcanvas">
  <div class="card-body d-flex align-items-center px-3 py-2">
    <div class="position-relative rounded-start chatbot-toggle-icon">
      <div class="settings-popover"><span class="ripple"><span
            class="fa-spin position-absolute all-0 d-flex flex-center"><span
              class="icon-spin position-absolute all-0 d-flex flex-center">
              <svg width="20" height="20" viewBox="0 0 20 20" fill="#ffffff" xmlns="http://www.w3.org/2000/svg">
                <path
                  d="M10 2C5.58 2 2 5.58 2 10c0 1.54.36 2.98 1 4.28L1 19l4.72-1c1.3.64 2.74 1 4.28 1 4.42 0 8-3.58 8-8s-3.58-8-8-8zm0 14.5c-1.19 0-2.38-.31-3.34-.84l-.24-.12-2.5.65.65-2.5-.12-.24C4.31 12.38 4 11.19 4 10c0-3.31 2.69-6 6-6s6 2.69 6 6-2.69 6-6 6z"
                  fill="#2A7BE4"></path>
              </svg></span></span></span></div>
    </div><small class="text-uppercase text-body-tertiary fw-bold py-2 pe-2 ps-1 rounded-end">chat</small>
  </div>
</a>

<!-- All chatbot JavaScript logic is now in /layout/chatbot-core.js -->
